from typing import List, Dict, Any
import numpy as np
from sentence_transformers import SentenceTransformer

# -----------------------------
# LOCAL EMBEDDING MODEL
# -----------------------------
MODEL = SentenceTransformer(
    "nomic-ai/nomic-embed-text-v1.5",
    trust_remote_code=True,
    device="cpu"  # Change to "cuda" if available
)

def embed_texts(texts: List[str]) -> np.ndarray:
    """Embed list of texts with normalized embeddings for cosine similarity."""
    embeddings = MODEL.encode(texts, normalize_embeddings=True)
    return np.array(embeddings)

# -----------------------------
# Cognitive Vulnerability Definitions
# -----------------------------
COGNITIVE_VULNERABILITIES = [
    {
        "name": "Fear Response",
        "description": "Heightened reactivity to perceived threats, leading to panic or compliance. Triggered by danger, crisis, or existential framing.",
        "indicators": ["threat", "danger", "crisis", "attack", "existential", "survival", "fear", "terror", "nazi", "communist", "war", "genocide"]
    },
    {
        "name": "Institutional Distrust",
        "description": "Reduced trust in authorities, elites, or systems. Exploited by corruption, conspiracy, or 'deep state' narratives.",
        "indicators": ["corrupt", "elite", "deep state", "rigged", "conspiracy", "distrust", "betrayal", "regime"]
    },
    {
        "name": "Confirmation Bias Amplification",
        "description": "Tendency to accept information that confirms existing beliefs. Amplified by echo chambers and selective exposure.",
        "indicators": ["believe", "truth", "already knew", "finally", "exposed", "proof", "confirmation", "reliable sources"]
    },
    {
        "name": "Identity Polarization",
        "description": "Strengthened in-group loyalty and out-group hostility. Exploited by 'us vs them' framing.",
        "indicators": ["us vs them", "enemy", "traitor", "loyal", "patriot", "real people", "outsider"]
    },
    {
        "name": "Scarcity & Urgency Bias",
        "description": "Impulsive action driven by perceived limited time or resources. Triggered by 'now or never' language.",
        "indicators": ["urgent", "limited time", "now or never", "last chance", "crisis window", "immediate"]
    },
    {
        "name": "Authority Deference",
        "description": "Excessive trust in perceived experts or leaders. Exploited by fake credentials or official tone.",
        "indicators": ["expert", "official", "authority", "leader", "doctor", "scientist", "general", "trustworthy"]
    },
    {
        "name": "Social Proof Exploitation",
        "description": "Following the crowd due to perceived consensus. Amplified by 'everyone knows' or viral trends.",
        "indicators": ["everyone", "majority", "trending", "consensus", "millions", "going viral"]
    },
    {
        "name": "Moral Outrage Induction",
        "description": "Emotional anger at perceived injustice, driving impulsive sharing or action.",
        "indicators": ["outrage", "injustice", "unfair", "disgusting", "evil", "moral", "immoral", "shame", "illegal", "unjust", "unjustified"]
    },
    {
        "name": "Victimhood Narrative Resonance",
        "description": "Identification with victim framing, increasing emotional investment and defensiveness.",
        "indicators": ["victim", "oppressed", "suffering", "persecuted", "targeted", "silenced", "marginalized", "wronged", "ignored"]
    },
    {
        "name": "Heroic Savior Framing",
        "description": "Belief in a heroic figure or movement that will 'save' or 'liberate'. Exploits hope and loyalty.",
        "indicators": ["hero", "savior", "liberation", "rescue", "fight back", "revolution", "rise up", "take action", "join us", "stand against"]
    }
]

# Precompute vulnerability embeddings
print("Precomputing cognitive vulnerability embeddings...")
vuln_texts = [f"{v['name']}: {v['description']} {' '.join(v['indicators'])}" for v in COGNITIVE_VULNERABILITIES]
vuln_embeddings = embed_texts(vuln_texts)
VULN_EMBEDDINGS = vuln_embeddings  # List in same order as COGNITIVE_VULNERABILITIES

print(f"Cognitive vulnerability diagnosis ready ({len(COGNITIVE_VULNERABILITIES)} vulnerabilities loaded)")

def diagnose_cognitive_vulnerabilities(
    narrative_text: str,
    target_audience_profile: Dict[str, Any],
    top_k: int = 10,
    min_confidence: float = 0.4
) -> List[Dict[str, Any]]:
    """
    Diagnose top cognitive vulnerabilities directly from narrative and audience profile.
    Pure local embedding similarity â€” no registry, no hallucinations.
    """
    if not narrative_text.strip():
        return []

    # Combine narrative + audience context
    ta_text = " ".join([f"{k}:{v}" for k, v in target_audience_profile.items() if v])
    full_context = f"{narrative_text} {ta_text}"
    context_emb = embed_texts([full_context])[0]

    results = []
    for i, vuln in enumerate(COGNITIVE_VULNERABILITIES):
        vuln_emb = VULN_EMBEDDINGS[i]
        sim = float(np.dot(context_emb, vuln_emb))

        if sim >= min_confidence:
            results.append({
                "name": vuln["name"],
                "description": vuln["description"],
                "confidence": round(sim, 3),
                "indicators_matched": [ind for ind in vuln["indicators"] if ind.lower() in full_context.lower()]
            })

    # Sort by confidence descending
    results.sort(key=lambda x: x["confidence"], reverse=True)

    return results[:top_k]